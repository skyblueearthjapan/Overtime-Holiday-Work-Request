<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#eaf6ff;
      --bg2:#f7fffb;
      --accent:#1f9d55;
      --accent2:#0ea5e9;
      --text:#0b2545;
      --muted:#5c6b7a;
      --card:#ffffffcc;
      --line:#d7e7f5;
      --danger:#ff5a5f;
      --warn:#ffb020;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 600px at 18% 0%, var(--bg1), transparent),
        radial-gradient(1100px 600px at 92% 20%, var(--bg2), transparent),
        linear-gradient(180deg, #ffffff, #f3fbff);
    }
    header{
      padding:18px 22px;
      display:flex; align-items:flex-end; justify-content:space-between;
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(8px);
      position:sticky; top:0;
      background: rgba(255,255,255,.55);
      z-index: 10;
    }
    .title{ font-weight:900; letter-spacing:.06em; }
    .sub{ opacity:.8; font-size:12px; color:var(--muted); }
    .wrap{ padding:18px 22px; max-width:1060px; margin:0 auto; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px;
      box-shadow: 0 10px 30px rgba(10,40,80,.06);
    }
    .grid2{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .kpi2{ font-size:18px; font-weight:900; }
    .action-card{
      cursor:pointer;
      text-align:center;
      padding:28px 14px;
      transition: transform .12s, box-shadow .12s;
    }
    .action-card:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 36px rgba(10,40,80,.12);
    }
    .action-card.overtime{ border-left:4px solid var(--accent2); }
    .action-card.holiday{ border-left:4px solid var(--accent); }

    .sectionTitle{
      font-weight:900;
      letter-spacing:.05em;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .section-count{
      font-size:13px; font-weight:700; color:var(--accent2);
      margin-left:8px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:left;
    }
    th{
      font-size:12px;
      color:var(--muted);
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      background:linear-gradient(135deg, var(--accent), #1bd67f);
      color:#fff; font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(31,157,85,.20);
    }
    .ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn-blue{
      background:linear-gradient(135deg, var(--accent2), #38bdf8);
      box-shadow:0 10px 22px rgba(14,165,233,.20);
    }
    .btn-sm{ padding:6px 10px; font-size:12px; border-radius:8px; }
    .btn-warn{
      background:linear-gradient(135deg, var(--warn), #ffc655);
      color:var(--text);
      box-shadow:0 6px 16px rgba(255,176,32,.20);
    }
    .btn-danger{
      background:linear-gradient(135deg, var(--danger), #ff8a8e);
      box-shadow:0 6px 16px rgba(255,90,95,.20);
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#fff;
      display:inline-block;
      color:var(--text);
    }
    .danger{ border-color:#ffb3b3; background:#fff0f0; color:#7a0b0b; }
    .warn{ border-color:#ffd29e; background:#fff6eb; color:#7a4a0b; }
    .ok{ border-color:#bfe9d0; background:#f0fff6; color:#0b5a2b; }
    .info{ border-color:#b3d4ff; background:#f0f7ff; color:#0b2a5a; }
    .muted{ color:var(--muted); }
    a{ color:var(--accent2); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .nav-link{
      font-size:13px; padding:6px 12px; border-radius:8px;
      border:1px solid var(--line); background:#fff; color:var(--text);
    }
    .nav-link:hover{ background:var(--bg1); text-decoration:none; }
    .loading{ text-align:center; padding:30px; color:var(--muted); }
    .order-slot{ display:flex; align-items:center; }
    .order-item{
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      cursor:pointer;
      font-size:13px;
      transition: background .1s;
    }
    .order-item:hover{ background:var(--bg1); }
    .order-item .order-code{ font-weight:700; }
    .order-item .order-detail{ color:var(--muted); font-size:12px; margin-top:2px; }

    @media (max-width:640px){
      header{ flex-direction:column; align-items:flex-start; gap:8px; }
      .wrap{ padding:12px 10px; }
      .grid2{ grid-template-columns:1fr; }
      table{ font-size:12px; }
      th, td{ padding:8px 4px; }
      .row{ flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">残業・休日出勤 申請TOP</div>
      <div class="sub" id="headerSub">全社の本日残業 / 今週末休日出勤 一覧</div>
    </div>
    <div class="row">
      <a href="<?= APP_URL ?>?page=approver" target="_top" class="nav-link">承認者画面</a>
      <a href="<?= APP_URL ?>?page=admin" target="_top" class="nav-link">総務部画面</a>
    </div>
  </header>

  <div class="wrap">

    <!-- 申請用：部署 + 作業員選択 -->
    <div class="card" style="margin-bottom:12px; padding:12px 16px;">
      <div style="font-weight:800; font-size:13px; margin-bottom:8px; color:var(--muted);">申請フォーム</div>
      <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <label style="font-weight:700; font-size:14px;">部署：</label>
        <select id="deptSelect" style="padding:8px 14px; border-radius:999px; border:1px solid var(--line); font-size:14px; font-weight:700; min-width:180px;">
          <option value="">読込中...</option>
        </select>
        <label style="font-weight:700; font-size:14px;">作業員：</label>
        <select id="workerSelect" style="padding:8px 14px; border-radius:999px; border:1px solid var(--line); font-size:14px; font-weight:700; min-width:200px;">
          <option value="">-- 部署を先に選択 --</option>
        </select>
        <div class="grid2" style="gap:8px;">
          <button class="btn-blue btn-sm" onclick="openForm('overtime')" style="white-space:nowrap;">残業申請</button>
          <button class="btn-sm" onclick="openForm('holiday')" style="white-space:nowrap;">休日出勤申請</button>
        </div>
      </div>
    </div>

    <!-- 残業セクション（本日） -->
    <div class="card" style="margin-bottom:12px;">
      <div class="sectionTitle">
        <div>
          本日の残業申請（<span id="todayDate">-</span>）
          <span class="section-count" id="otCount"></span>
        </div>
        <button class="ghost btn-sm" onclick="loadDashboard()">更新</button>
      </div>
      <table id="tblOvertime">
        <thead>
          <tr>
            <th>部署</th>
            <th>氏名</th>
            <th>承認</th>
            <th>予定</th>
            <th>実績</th>
            <th>休憩</th>
            <th>実残業</th>
            <th>PDF</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="9" class="loading">読込中...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 休日出勤セクション（今週末） -->
    <div class="card">
      <div class="sectionTitle">
        <div>
          今週末の休日出勤申請（<span id="weekendRange">-</span>）
          <span class="section-count" id="hdCount"></span>
        </div>
      </div>
      <table id="tblHoliday">
        <thead>
          <tr>
            <th>日付</th>
            <th>部署</th>
            <th>氏名</th>
            <th>承認</th>
            <th>予定</th>
            <th>実績</th>
            <th>休憩</th>
            <th>実働</th>
            <th>PDF</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="10" class="loading">読込中...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- 工番選択モーダル -->
  <div id="orderPickerWrap" style="display:none;">
    <div style="position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:200;" onclick="closeOrderPicker()"></div>
    <div class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:201; max-width:480px; width:94%; padding:24px; max-height:85vh; display:flex; flex-direction:column;">
      <div style="font-weight:900; font-size:16px; margin-bottom:2px;">工番選択（任意）</div>
      <div class="sub" style="margin-bottom:12px;">間接業務の方は「工番なしで申請」をお選びください</div>

      <!-- 選択済み工番スロット -->
      <div id="orderSlots" style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;">
        <div class="order-slot" id="orderSlot1" style="display:none;">
          <span class="pill info" style="flex:1; text-align:left;">
            <b>工番1:</b> <span class="slot-label"></span>
          </span>
          <button class="ghost btn-sm" onclick="clearOrderSlot(0)" style="margin-left:6px; color:var(--danger);">×</button>
        </div>
        <div class="order-slot" id="orderSlot2" style="display:none;">
          <span class="pill info" style="flex:1; text-align:left;">
            <b>工番2:</b> <span class="slot-label"></span>
          </span>
          <button class="ghost btn-sm" onclick="clearOrderSlot(1)" style="margin-left:6px; color:var(--danger);">×</button>
        </div>
        <div class="order-slot" id="orderSlot3" style="display:none;">
          <span class="pill info" style="flex:1; text-align:left;">
            <b>工番3:</b> <span class="slot-label"></span>
          </span>
          <button class="ghost btn-sm" onclick="clearOrderSlot(2)" style="margin-left:6px; color:var(--danger);">×</button>
        </div>
      </div>

      <!-- 検索入力 -->
      <input type="text" id="orderSearchInput" placeholder="工番・品名・納入先で検索..."
        style="width:100%; padding:10px 14px; border-radius:10px; border:1px solid var(--line); font-size:14px; box-sizing:border-box; margin-bottom:8px;"
        oninput="filterOrders()" />

      <!-- 検索結果 -->
      <div id="orderResults" style="flex:1; overflow-y:auto; max-height:240px; border:1px solid var(--line); border-radius:10px; background:#fff;">
        <div class="loading" id="orderLoading">工番マスタを読込中...</div>
      </div>

      <!-- ボタン -->
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
        <button class="ghost" onclick="closeOrderPicker()">キャンセル</button>
        <button class="ghost" onclick="submitOrderPicker(true)" style="color:var(--muted);">工番なしで申請</button>
        <button class="btn-blue" onclick="submitOrderPicker(false)">この工番で申請</button>
      </div>
    </div>
  </div>

  <!-- 休日出勤：日付選択モーダル -->
  <div id="datePickerWrap" style="display:none;">
    <div style="position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:100;" onclick="closeDatePicker()"></div>
    <div class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:101; max-width:360px; width:90%; padding:24px;">
      <div style="font-weight:900; font-size:16px; margin-bottom:4px;">休日出勤 - 作業実施日を選択</div>
      <div class="sub" style="margin-bottom:14px;">今週の土日・祝日から選んでください</div>
      <div id="dateButtons" style="display:flex; flex-direction:column; gap:8px;"></div>
      <!-- フォールバック：カレンダーから日付を直接選択 -->
      <div style="border-top:1px solid var(--line); margin-top:14px; padding-top:14px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">上記以外の日付：</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="date" id="manualDateInput" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--line); font-size:14px;" />
          <button class="ghost" style="white-space:nowrap; padding:10px 14px;" onclick="onManualDateSelect()">この日付で申請</button>
        </div>
      </div>
      <div style="text-align:center; margin-top:14px;">
        <button class="ghost btn-sm" onclick="closeDatePicker()">キャンセル</button>
      </div>
    </div>
  </div>

<script>
var SELECTED_DEPT = '';
var SELECTED_WORKER_CODE = '';

function fmtMin(min){
  min = Math.max(0, Math.round(Number(min||0)));
  var h = Math.floor(min/60), r = min % 60;
  if(h===0) return r+'分';
  if(r===0) return h+'時間';
  return h+'時間'+r+'分';
}

// ====== 初期ロード：部署一覧 ======
google.script.run
  .withSuccessHandler(function(depts){
    var sel = document.getElementById('deptSelect');
    sel.innerHTML = '<option value="">-- 部署を選択 --</option>';
    (depts || []).forEach(function(d){
      var opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      sel.appendChild(opt);
    });
  })
  .withFailureHandler(function(){})
  .api_getDeptList();

// ====== 初期ロード：全社ダッシュボード ======
loadDashboard();

// ====== 部署変更時（申請フォーム用） ======
document.getElementById('deptSelect').addEventListener('change', onDeptChange);

function onDeptChange(){
  var dept = document.getElementById('deptSelect').value;
  SELECTED_DEPT = dept;
  SELECTED_WORKER_CODE = '';

  var wSel = document.getElementById('workerSelect');
  wSel.innerHTML = '<option value="">読込中...</option>';

  if(!dept) {
    wSel.innerHTML = '<option value="">-- 部署を先に選択 --</option>';
    return;
  }

  google.script.run
    .withSuccessHandler(function(workers){
      wSel.innerHTML = '<option value="">-- 作業員を選択 --</option>';
      (workers || []).forEach(function(w){
        var code = w.split(/\s+/)[0] || '';
        var opt = document.createElement('option');
        opt.value = code;
        opt.textContent = w;
        wSel.appendChild(opt);
      });
    })
    .withFailureHandler(function(){
      wSel.innerHTML = '<option value="">取得エラー</option>';
    })
    .api_getWorkersByDept(dept);
}

// ====== 作業員変更時（申請フォーム用） ======
document.getElementById('workerSelect').addEventListener('change', function(){
  var wSel = document.getElementById('workerSelect');
  SELECTED_WORKER_CODE = wSel.value;
});

// ====== フォームURL取得（プリフィル付き） ======
function openForm(type){
  var dept = SELECTED_DEPT || document.getElementById('deptSelect').value;
  if(!dept){
    alert('部署を選択してください。');
    return;
  }

  var wSel = document.getElementById('workerSelect');
  var workerLabel = '';
  if(wSel.selectedIndex > 0){
    workerLabel = wSel.options[wSel.selectedIndex].textContent;
  }
  if(!workerLabel){
    alert('作業員を選択してください。');
    return;
  }

  // 休日出勤 → 日付選択モーダル
  if(type === 'holiday'){
    showDatePicker(dept, workerLabel);
    return;
  }

  // 残業 → 工番選択モーダル
  showOrderPicker(type, dept, workerLabel, '');
}

// ====== 休日日付選択モーダル ======
var PICKER_DEPT = '';
var PICKER_WORKER = '';

function showDatePicker(dept, workerLabel){
  PICKER_DEPT = dept;
  PICKER_WORKER = workerLabel;
  var wrap = document.getElementById('datePickerWrap');
  var btns = document.getElementById('dateButtons');
  btns.innerHTML = '<div class="loading">候補日を取得中...</div>';
  document.getElementById('manualDateInput').value = '';
  wrap.style.display = 'block';

  google.script.run
    .withSuccessHandler(function(candidates){
      btns.innerHTML = '';
      if(!candidates || candidates.length === 0){
        btns.innerHTML = '<div class="muted">候補日が見つかりませんでした</div>';
        return;
      }
      candidates.forEach(function(c){
        var btn = document.createElement('button');
        if(c.type === 'holiday'){
          btn.className = 'btn-warn';
        }
        btn.style.cssText = 'width:100%; padding:14px; font-size:15px; border-radius:12px;';
        var label = c.label;
        if(c.holidayName) label += ' (' + c.holidayName + ')';
        btn.textContent = label;
        btn.onclick = function(){
          closeDatePicker();
          showOrderPicker('holiday', PICKER_DEPT, PICKER_WORKER, c.date);
        };
        btns.appendChild(btn);
      });
    })
    .withFailureHandler(function(err){
      btns.innerHTML = '<div class="muted">取得エラー: ' + (err.message || err) + '</div>';
    })
    .api_getHolidayCandidateDates();
}

function closeDatePicker(){
  document.getElementById('datePickerWrap').style.display = 'none';
}

function onManualDateSelect(){
  var val = document.getElementById('manualDateInput').value;
  if(!val){
    alert('日付を選択してください。');
    return;
  }
  closeDatePicker();
  showOrderPicker('holiday', PICKER_DEPT, PICKER_WORKER, val);
}

// ====== 工番選択モーダル ======
var ORDER_CACHE = [];
var ORDER_SELECTED = ['','',''];
var ORDER_CONTEXT = {};

function showOrderPicker(type, dept, workerLabel, targetDateStr){
  ORDER_CONTEXT = { type: type, dept: dept, workerLabel: workerLabel, targetDateStr: targetDateStr };
  ORDER_SELECTED = ['','',''];
  updateOrderSlots();
  document.getElementById('orderSearchInput').value = '';
  document.getElementById('orderPickerWrap').style.display = 'block';

  if(ORDER_CACHE.length > 0){
    filterOrders();
    return;
  }

  document.getElementById('orderResults').innerHTML =
    '<div class="loading" id="orderLoading">工番マスタを読込中...</div>';
  google.script.run
    .withSuccessHandler(function(list){
      ORDER_CACHE = list || [];
      filterOrders();
    })
    .withFailureHandler(function(err){
      document.getElementById('orderResults').innerHTML =
        '<div class="muted" style="padding:16px;">読込エラー: ' + (err.message || err) + '</div>';
    })
    .api_getOrderList();
}

function closeOrderPicker(){
  document.getElementById('orderPickerWrap').style.display = 'none';
}

function filterOrders(){
  var q = (document.getElementById('orderSearchInput').value || '').toLowerCase().trim();
  var container = document.getElementById('orderResults');

  if(!q){
    container.innerHTML =
      '<div class="muted" style="padding:16px; text-align:center;">工番・品名・納入先を入力して検索</div>';
    return;
  }

  var terms = q.split(/\s+/).filter(function(t){ return t.length > 0; });

  var matched = ORDER_CACHE.filter(function(o){
    var haystack = (o.code + ' ' + o.product + ' ' + o.dest).toLowerCase();
    return terms.every(function(t){ return haystack.indexOf(t) >= 0; });
  });

  if(matched.length === 0){
    container.innerHTML =
      '<div class="muted" style="padding:16px; text-align:center;">該当する工番がありません</div>';
    return;
  }

  var html = '';
  var limit = Math.min(matched.length, 100);
  for(var i = 0; i < limit; i++){
    var o = matched[i];
    var detail = '';
    if(o.product) detail += o.product;
    if(o.product && o.dest) detail += ' ／ ';
    if(o.dest) detail += o.dest;
    html += '<div class="order-item" onclick="selectOrder(\'' + o.code.replace(/'/g, "\\'") + '\')">' +
      '<div class="order-code">' + escHtml(o.code) + '</div>' +
      (detail ? '<div class="order-detail">' + escHtml(detail) + '</div>' : '') +
      '</div>';
  }
  if(matched.length > 100){
    html += '<div class="muted" style="padding:10px; text-align:center;">他 ' + (matched.length - 100) + ' 件…検索を絞り込んでください</div>';
  }
  container.innerHTML = html;
}

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function selectOrder(code){
  for(var i = 0; i < 3; i++){
    if(!ORDER_SELECTED[i]){
      ORDER_SELECTED[i] = code;
      updateOrderSlots();
      return;
    }
  }
  alert('工番は最大3件まで選択できます。\n不要な工番を×で削除してください。');
}

function clearOrderSlot(idx){
  ORDER_SELECTED[idx] = '';
  var compact = ORDER_SELECTED.filter(function(c){ return c !== ''; });
  while(compact.length < 3) compact.push('');
  ORDER_SELECTED = compact;
  updateOrderSlots();
}

function updateOrderSlots(){
  for(var i = 0; i < 3; i++){
    var el = document.getElementById('orderSlot' + (i+1));
    if(ORDER_SELECTED[i]){
      el.style.display = 'flex';
      var info = ORDER_CACHE.find(function(o){ return o.code === ORDER_SELECTED[i]; });
      var label = ORDER_SELECTED[i];
      if(info){
        if(info.product) label += ' ｜ ' + info.product;
        if(info.dest) label += ' ／ ' + info.dest;
      }
      el.querySelector('.slot-label').textContent = label;
    } else {
      el.style.display = 'none';
    }
  }
}

function submitOrderPicker(skipAll){
  closeOrderPicker();
  var codes = skipAll ? [] : ORDER_SELECTED.filter(function(c){ return c !== ''; });
  doOpenForm(
    ORDER_CONTEXT.type,
    ORDER_CONTEXT.dept,
    ORDER_CONTEXT.workerLabel,
    ORDER_CONTEXT.targetDateStr,
    codes
  );
}

// ====== 共通：フォームを開く ======
function doOpenForm(type, dept, workerLabel, targetDateStr, orderCodes){
  var label = (type === 'overtime') ? '残業' : '休日出勤';

  // ポップアップブロッカー対策
  var newWin = window.open('about:blank', '_blank');
  if(newWin){
    newWin.document.write(
      '<html><body style="font-family:system-ui,sans-serif;display:flex;align-items:center;' +
      'justify-content:center;height:100vh;margin:0;color:#5c6b7a;">' +
      '<div style="text-align:center;"><p style="font-size:18px;font-weight:700;">' +
      label + '申請フォームを準備中...</p>' +
      '<p style="font-size:13px;">しばらくお待ちください</p></div></body></html>'
    );
  }

  google.script.run
    .withSuccessHandler(function(url){
      if(url && newWin){
        newWin.location.href = url;
      } else if(url && !newWin){
        showFormLink(url, label);
      } else {
        if(newWin) newWin.close();
        alert(label + '申請フォームを作成できませんでした。管理者に連絡してください。');
      }
    })
    .withFailureHandler(function(err){
      if(newWin) newWin.close();
      alert(label + 'フォーム取得エラー: ' + (err.message || err));
    })
    .api_getFormUrl(type, dept, workerLabel, targetDateStr, orderCodes || []);
}

function showFormLink(url, label){
  var div = document.createElement('div');
  div.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);' +
    'z-index:300;background:#fff;border:2px solid var(--accent2);border-radius:18px;' +
    'padding:24px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:360px;width:90%;';
  div.innerHTML =
    '<div style="font-weight:900;font-size:16px;margin-bottom:8px;">ポップアップがブロックされました</div>' +
    '<div class="sub" style="margin-bottom:14px;">下のリンクをクリックしてフォームを開いてください</div>' +
    '<a href="' + url + '" target="_blank" style="display:inline-block;padding:12px 24px;' +
    'background:linear-gradient(135deg,var(--accent2),#38bdf8);color:#fff;border-radius:12px;' +
    'font-weight:800;text-decoration:none;">' + label + 'フォームを開く</a>' +
    '<div style="margin-top:12px;"><button class="ghost btn-sm" onclick="this.parentElement.parentElement.remove()">閉じる</button></div>';
  document.body.appendChild(div);
}

// ====== 全社ダッシュボード読込 ======
function loadDashboard(){
  var otTb = document.querySelector('#tblOvertime tbody');
  var hdTb = document.querySelector('#tblHoliday tbody');
  otTb.innerHTML = '<tr><td colspan="9" class="loading">読込中...</td></tr>';
  hdTb.innerHTML = '<tr><td colspan="10" class="loading">読込中...</td></tr>';

  google.script.run
    .withSuccessHandler(function(res){
      console.log('api_getDashboard 結果:', JSON.stringify(res));
      if(!res){
        otTb.innerHTML = '<tr><td colspan="9" class="muted" style="text-align:center;padding:24px">データを取得できませんでした（res=null）</td></tr>';
        hdTb.innerHTML = '<tr><td colspan="10" class="muted" style="text-align:center;padding:24px">デプロイの更新を確認してください</td></tr>';
        return;
      }
      if(res.error){
        otTb.innerHTML = '<tr><td colspan="9" class="muted" style="text-align:center;padding:24px">サーバーエラー: ' + escHtml(res.error) + '</td></tr>';
        hdTb.innerHTML = '<tr><td colspan="10"></td></tr>';
        return;
      }
      renderDashboard(res);
    })
    .withFailureHandler(function(err){
      console.error('api_getDashboard 失敗:', err);
      otTb.innerHTML = '<tr><td colspan="9" class="muted" style="text-align:center;padding:24px">API失敗: ' + escHtml(err.message || err) + '</td></tr>';
      hdTb.innerHTML = '<tr><td colspan="10" class="muted" style="text-align:center;padding:24px">GASエディタのログも確認してください</td></tr>';
    })
    .api_getDashboard();
}

// ====== ダッシュボード描画 ======
function renderDashboard(res){
  document.getElementById('todayDate').innerText = res.today;
  document.getElementById('weekendRange').innerText = res.weekendStart + ' ～ ' + res.weekendEnd;

  // 残業テーブル
  var otTb = document.querySelector('#tblOvertime tbody');
  otTb.innerHTML = '';
  document.getElementById('otCount').innerText = res.overtime.length + '名';

  if(!res.overtime || res.overtime.length === 0){
    otTb.innerHTML =
      '<tr><td colspan="9" class="muted" style="text-align:center;padding:24px">' +
      '本日の残業申請はありません</td></tr>';
  } else {
    res.overtime.forEach(function(it){ otTb.appendChild(buildOvertimeRow(it)); });
  }

  // 休日テーブル
  var hdTb = document.querySelector('#tblHoliday tbody');
  hdTb.innerHTML = '';
  document.getElementById('hdCount').innerText = res.holiday.length + '名';

  if(!res.holiday || res.holiday.length === 0){
    hdTb.innerHTML =
      '<tr><td colspan="10" class="muted" style="text-align:center;padding:24px">' +
      '今週末の休日出勤申請はありません</td></tr>';
  } else {
    res.holiday.forEach(function(it){ hdTb.appendChild(buildHolidayRow(it)); });
  }
}

// ====== 残業行 ======
function buildOvertimeRow(it){
  var statusPill = it.status === 'submitted'
    ? '<span class="pill warn">承認待ち</span>'
    : '<span class="pill ok">承認済</span>';

  var pdfCell = buildPdfCell(it);
  var actionCell = buildActionCell(it);

  var tr = document.createElement('tr');
  tr.setAttribute('data-request-id', it.requestId);
  tr.innerHTML =
    '<td>' + escHtml(it.dept) + '</td>' +
    '<td><b>' + escHtml(it.workerName) + '</b></td>' +
    '<td>' + statusPill + '</td>' +
    '<td>' + fmtMin(it.approvedMinutes) + '</td>' +
    '<td>' + (it.actualMinutes > 0 ? fmtMin(it.actualMinutes) : '<span class="muted">-</span>') + '</td>' +
    '<td>' + (it.breakMinutes > 0 ? fmtMin(it.breakMinutes) : '<span class="muted">-</span>') + '</td>' +
    '<td>' + (it.netMinutes > 0 ? '<b>' + fmtMin(it.netMinutes) + '</b>' : '<span class="muted">-</span>') + '</td>' +
    '<td>' + pdfCell + '</td>' +
    '<td>' + actionCell + '</td>';
  return tr;
}

// ====== 休日行 ======
function buildHolidayRow(it){
  var statusPill = it.status === 'submitted'
    ? '<span class="pill warn">承認待ち</span>'
    : '<span class="pill ok">承認済</span>';

  var pdfCell = buildPdfCell(it);
  var actionCell = buildActionCell(it);

  var tr = document.createElement('tr');
  tr.setAttribute('data-request-id', it.requestId);
  tr.innerHTML =
    '<td>' + escHtml(it.targetDateLabel || it.targetDate) + '</td>' +
    '<td>' + escHtml(it.dept) + '</td>' +
    '<td><b>' + escHtml(it.workerName) + '</b></td>' +
    '<td>' + statusPill + '</td>' +
    '<td>' + fmtMin(it.approvedMinutes) + '</td>' +
    '<td>' + (it.actualMinutes > 0 ? fmtMin(it.actualMinutes) : '<span class="muted">-</span>') + '</td>' +
    '<td>' + (it.breakMinutes > 0 ? fmtMin(it.breakMinutes) : '<span class="muted">-</span>') + '</td>' +
    '<td>' + (it.netMinutes > 0 ? '<b>' + fmtMin(it.netMinutes) + '</b>' : '<span class="muted">-</span>') + '</td>' +
    '<td>' + pdfCell + '</td>' +
    '<td>' + actionCell + '</td>';
  return tr;
}

// ====== PDF列 ======
function buildPdfCell(it){
  if(it.pdfFileId){
    return '<a href="https://drive.google.com/file/d/' +
      it.pdfFileId + '/view" target="_blank" class="pill ok">PDF</a>';
  } else if(it.netMinutes > 0 && it.status === 'approved'){
    return '<span class="pill warn">未作成</span>';
  }
  return '<span class="muted">-</span>';
}

// ====== 操作ボタン構築 ======
function buildActionCell(it){
  if(it.status === 'submitted'){
    return '<span class="muted">承認待ち</span>';
  }

  if(it.requestType === 'overtime'){
    if(it.actualEndAt){
      return '<span class="pill ok">完了済</span>';
    }
    return '<button class="btn-blue btn-sm" ' +
      'onclick="doOvertimeDone(\'' + it.requestId + '\',this)">残業完了</button>';
  }

  if(it.requestType === 'holiday'){
    if(it.actualEndAt){
      return '<span class="pill ok">完了済</span>';
    }
    if(it.actualStartAt){
      return '<button class="btn-sm" ' +
        'onclick="doHolidayDone(\'' + it.requestId + '\',this)">休日完了</button>';
    }
    return '<button class="btn-warn btn-sm" ' +
      'onclick="doHolidayStart(\'' + it.requestId + '\',this)">開始</button>';
  }

  return '-';
}

function updateRowAction(requestId, newHtml) {
  var row = document.querySelector('tr[data-request-id="' + requestId + '"]');
  if (!row) return;
  var cells = row.querySelectorAll('td');
  cells[cells.length - 1].innerHTML = newHtml;
  row.style.transition = 'background 0.4s';
  row.style.background = 'rgba(14,165,233,0.08)';
  setTimeout(function(){ row.style.background = ''; }, 1200);
}

// ====== 残業完了 ======
function doOvertimeDone(requestId, btn){
  if(!confirm('残業完了を記録しますか？\n（17:20から現在時刻まで自動計算されます）')) return;
  btn.disabled = true;
  updateRowAction(requestId, '<span class="pill ok">完了済</span>');

  google.script.run
    .withSuccessHandler(function(res){
      // 実績値をセルに反映（サーバーの計算結果）
      var row = document.querySelector('tr[data-request-id="' + requestId + '"]');
      if(row){
        var c = row.querySelectorAll('td');
        // 残業行: dept,name,status,plan,actual,break,net,pdf,action (9列)
        c[4].innerHTML = fmtMin(res.actualMinutes);
        c[5].innerHTML = fmtMin(res.breakMinutes);
        c[6].innerHTML = '<b>' + fmtMin(res.netMinutes) + '</b>';
      }
      alert('残業完了を記録しました。\n実働: ' + fmtMin(res.actualMinutes) +
        '\n休憩控除: ' + fmtMin(res.breakMinutes) + '\n実残業: ' + fmtMin(res.netMinutes));
    })
    .withFailureHandler(function(err){
      alert('エラー: ' + (err.message || err));
      loadDashboard();
    })
    .api_markOvertimeDone(requestId);
}

// ====== 休日開始 ======
function doHolidayStart(requestId, btn){
  if(!confirm('休日出勤を開始しますか？\n（現在時刻が開始時刻として記録されます）')) return;
  btn.disabled = true;
  updateRowAction(requestId,
    '<button class="btn-sm" onclick="doHolidayDone(\'' + requestId + '\',this)">休日完了</button>');

  google.script.run
    .withSuccessHandler(function(){})
    .withFailureHandler(function(err){
      alert('エラー: ' + (err.message || err));
      loadDashboard();
    })
    .api_markHolidayStart(requestId);
}

// ====== 休日完了 ======
function doHolidayDone(requestId, btn){
  if(!confirm('休日出勤を完了しますか？\n（開始時刻から現在時刻まで自動計算されます）')) return;
  btn.disabled = true;
  updateRowAction(requestId, '<span class="pill ok">完了済</span>');

  google.script.run
    .withSuccessHandler(function(res){
      var row = document.querySelector('tr[data-request-id="' + requestId + '"]');
      if(row){
        var c = row.querySelectorAll('td');
        // 休日行: date,dept,name,status,plan,actual,break,net,pdf,action (10列)
        c[5].innerHTML = fmtMin(res.actualMinutes);
        c[6].innerHTML = fmtMin(res.breakMinutes);
        c[7].innerHTML = '<b>' + fmtMin(res.netMinutes) + '</b>';
      }
      alert('休日出勤を完了しました。\n実働: ' + fmtMin(res.actualMinutes) +
        '\n休憩控除: ' + fmtMin(res.breakMinutes) + '\n実残業/実働: ' + fmtMin(res.netMinutes));
    })
    .withFailureHandler(function(err){
      alert('エラー: ' + (err.message || err));
      loadDashboard();
    })
    .api_markHolidayDone(requestId);
}
</script>
</body>
</html>
