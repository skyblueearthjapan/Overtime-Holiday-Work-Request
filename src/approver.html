<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#eaf6ff;
      --bg2:#f7fffb;
      --accent:#1f9d55;
      --accent2:#0ea5e9;
      --text:#0b2545;
      --muted:#5c6b7a;
      --card:#ffffffcc;
      --line:#d7e7f5;
      --danger:#ff5a5f;
      --warn:#ffb020;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 600px at 18% 0%, var(--bg1), transparent),
        radial-gradient(1100px 600px at 92% 20%, var(--bg2), transparent),
        linear-gradient(180deg, #ffffff, #f3fbff);
    }
    header{
      padding:18px 22px;
      display:flex; align-items:flex-end; justify-content:space-between;
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(8px);
      position:sticky; top:0;
      background: rgba(255,255,255,.55);
      z-index: 10;
    }
    .title{ font-weight:900; letter-spacing:.06em; }
    .sub{ opacity:.8; font-size:12px; color:var(--muted); }
    .wrap{ padding:18px 22px; max-width:1060px; margin:0 auto; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px;
      box-shadow: 0 10px 30px rgba(10,40,80,.06);
    }
    .kpi{ font-size:22px; font-weight:900; }
    .grid3{ display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; }
    .sectionTitle{
      font-weight:900;
      letter-spacing:.05em;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .section-count{
      font-size:13px; font-weight:700; color:var(--accent2);
      margin-left:8px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:left;
    }
    th{
      font-size:12px;
      color:var(--muted);
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      background:linear-gradient(135deg, var(--accent), #1bd67f);
      color:#fff; font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(31,157,85,.20);
    }
    .ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn-sm{ padding:6px 10px; font-size:12px; border-radius:8px; }
    .btn-approve{
      background:linear-gradient(135deg, var(--accent), #1bd67f);
      box-shadow:0 6px 16px rgba(31,157,85,.20);
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#fff;
      display:inline-block;
      color:var(--text);
    }
    .danger{ border-color:#ffb3b3; background:#fff0f0; color:#7a0b0b; }
    .warn{ border-color:#ffd29e; background:#fff6eb; color:#7a4a0b; }
    .ok{ border-color:#bfe9d0; background:#f0fff6; color:#0b5a2b; }
    .info{ border-color:#b3d4ff; background:#f0f7ff; color:#0b2a5a; }
    .muted{ color:var(--muted); }
    a{ color:var(--accent2); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .nav-link{
      font-size:13px; padding:6px 12px; border-radius:8px;
      border:1px solid var(--line); background:#fff; color:var(--text);
    }
    .nav-link:hover{ background:var(--bg1); text-decoration:none; }
    .loading{ text-align:center; padding:30px; color:var(--muted); }

    @media (max-width:640px){
      header{ flex-direction:column; align-items:flex-start; gap:8px; }
      .wrap{ padding:12px 10px; }
      .grid3{ grid-template-columns:1fr; }
      .row{ flex-direction:column; align-items:stretch; }
      table{ font-size:12px; }
      th, td{ padding:8px 4px; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">承認者画面</div>
      <div class="sub" id="approverSub">読込中...</div>
    </div>
    <div class="row">
      <button class="ghost btn-sm" id="btnChangeDept" onclick="initApprover()" style="display:none;">部署変更</button>
      <a href="<?= APP_URL ?>?page=top" target="_top" class="nav-link">トップへ</a>
      <a href="<?= APP_URL ?>?page=admin" target="_top" class="nav-link">総務部画面</a>
    </div>
  </header>

  <div class="wrap">

    <!-- KPI -->
    <div class="grid3" style="margin-bottom:12px">
      <div class="card">
        <div class="sub">申請件数（残業+休日）</div>
        <div class="kpi" id="kpiTotal">-</div>
      </div>
      <div class="card">
        <div class="sub">未承認</div>
        <div class="kpi" id="kpiPending" style="color:var(--warn)">-</div>
      </div>
      <div class="card">
        <div class="sub">承認済</div>
        <div class="kpi" id="kpiApproved" style="color:var(--accent)">-</div>
      </div>
    </div>

    <!-- 残業セクション -->
    <div class="card" style="margin-bottom:12px;">
      <div class="sectionTitle">
        <div>
          本日の残業申請（<span id="todayDate">-</span>）
          <span class="section-count" id="otCount"></span>
        </div>
        <div class="row" style="gap:6px;">
          <button class="ghost btn-sm" onclick="approveAllInTable('overtime')">残業 全件承認</button>
          <button class="ghost btn-sm" onclick="loadDashboard()">更新</button>
        </div>
      </div>
      <table id="tblOvertime">
        <thead>
          <tr>
            <th>部署</th>
            <th>氏名</th>
            <th>承認</th>
            <th>予定時間</th>
            <th>提出</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="loading">読込中...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 休日セクション -->
    <div class="card">
      <div class="sectionTitle">
        <div>
          今週末の休日出勤申請（<span id="weekendRange">-</span>）
          <span class="section-count" id="hdCount"></span>
        </div>
        <button class="ghost btn-sm" onclick="approveAllInTable('holiday')">休日 全件承認</button>
      </div>
      <table id="tblHoliday">
        <thead>
          <tr>
            <th>日付</th>
            <th>部署</th>
            <th>氏名</th>
            <th>承認</th>
            <th>予定時間</th>
            <th>提出</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" class="loading">読込中...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

<!-- 部署選択モーダル -->
<div id="deptModalWrap" style="display:none;">
  <div style="position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:100;"></div>
  <div class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:101; max-width:400px; width:90%; padding:24px; text-align:center;">
    <div style="font-weight:900; font-size:18px; margin-bottom:4px;">部署を選択</div>
    <div class="sub" style="margin-bottom:18px;">承認対象の部署を選んでください</div>
    <div id="deptModalBody">
      <div class="loading">承認者情報を確認中...</div>
    </div>
  </div>
</div>

<script>
var ALL_ITEMS = [];
var SELECTED_DEPT = '';

function fmtMin(min){
  min = Math.max(0, Math.round(Number(min||0)));
  var h = Math.floor(min/60), r = min % 60;
  if(h===0) return r+'分';
  if(r===0) return h+'時間';
  return h+'時間'+r+'分';
}

function z(n){ return String(n).padStart(2,'0'); }

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ====== 初期ロード ======
initApprover();

function initApprover(){
  SELECTED_DEPT = '';
  document.getElementById('btnChangeDept').style.display = 'none';
  document.getElementById('deptModalWrap').style.display = 'block';
  document.getElementById('deptModalBody').innerHTML = '<div class="loading">承認者情報を確認中...</div>';

  google.script.run
    .withSuccessHandler(function(res){
      var body = document.getElementById('deptModalBody');
      body.innerHTML = '';

      if(!res || !res.depts || res.depts.length === 0){
        body.innerHTML = '<div class="muted" style="padding:16px;">承認可能な部署がありません。</div>';
        return;
      }

      // 部署が1つだけ（非管理者）の場合はモーダルをスキップ
      if(!res.isAdmin && res.depts.length === 1){
        selectDept(res.depts[0]);
        return;
      }

      // 部署ボタンを動的生成
      res.depts.forEach(function(dept){
        var btn = document.createElement('button');
        btn.className = 'ghost';
        btn.style.cssText = 'width:100%; margin-bottom:8px; text-align:left; padding:12px 16px; font-size:14px;';
        btn.innerText = dept;
        btn.onclick = function(){ selectDept(dept); };
        body.appendChild(btn);
      });

      if(res.isAdmin){
        var note = document.createElement('div');
        note.className = 'sub';
        note.style.marginTop = '8px';
        note.innerText = '管理者: 全部署の承認が可能です';
        body.appendChild(note);
      }
    })
    .withFailureHandler(function(err){
      document.getElementById('deptModalBody').innerHTML =
        '<div class="muted" style="padding:16px;">エラー: ' + escHtml(err.message || err) + '</div>';
    })
    .api_getApproverDepts();
}

function selectDept(dept){
  SELECTED_DEPT = dept;
  closeDeptModal();
  loadDashboard(dept);
}

function closeDeptModal(){
  document.getElementById('deptModalWrap').style.display = 'none';
  document.getElementById('btnChangeDept').style.display = '';
}

function loadDashboard(dept){
  dept = dept || SELECTED_DEPT;
  if(!dept){
    initApprover();
    return;
  }
  SELECTED_DEPT = dept;

  var otTb = document.querySelector('#tblOvertime tbody');
  var hdTb = document.querySelector('#tblHoliday tbody');
  otTb.innerHTML = '<tr><td colspan="6" class="loading">読込中...</td></tr>';
  hdTb.innerHTML = '<tr><td colspan="7" class="loading">読込中...</td></tr>';

  google.script.run
    .withSuccessHandler(function(res){
      console.log('api_getApproverDashboard 結果:', JSON.stringify(res));
      if(!res){
        document.getElementById('approverSub').innerText = 'サーバーからnullが返されました';
        otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">データを取得できませんでした（res=null）。デプロイ済みか確認してください。</td></tr>';
        hdTb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:24px">デプロイの「新しいデプロイ」ではなく既存デプロイの更新が必要です</td></tr>';
        return;
      }

      // サーバー側でキャッチしたエラーを表示
      if(res.error){
        document.getElementById('approverSub').innerText = 'サーバーエラー';
        otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">サーバーエラー: ' + escHtml(res.error) + '</td></tr>';
        hdTb.innerHTML = '<tr><td colspan="7"></td></tr>';
        return;
      }

      document.getElementById('approverSub').innerText =
        (res.selectedDept || SELECTED_DEPT) + ' の申請' +
        (res.isAdmin ? '（管理者）' : '');

      ALL_ITEMS = (res.overtime || []).concat(res.holiday || []);
      renderDashboard(res);
    })
    .withFailureHandler(function(err){
      console.error('api_getApproverDashboard 失敗:', err);
      document.getElementById('approverSub').innerText = 'API呼出失敗';
      otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">API失敗: ' + escHtml(err.message || err) + '</td></tr>';
      hdTb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:24px">GASエディタのログ（実行数）も確認してください</td></tr>';
    })
    .api_getApproverDashboard(dept);
}

function renderDashboard(res){
  document.getElementById('todayDate').innerText = res.today;
  document.getElementById('weekendRange').innerText = res.weekendStart + ' ～ ' + res.weekendEnd;

  // KPI
  var allItems = (res.overtime || []).concat(res.holiday || []);
  var submitted = 0, approved = 0;
  allItems.forEach(function(it){
    if(it.status === 'submitted') submitted++;
    if(it.status === 'approved') approved++;
  });
  document.getElementById('kpiTotal').innerText = allItems.length;
  document.getElementById('kpiPending').innerText = submitted;
  document.getElementById('kpiApproved').innerText = approved;

  // 残業テーブル
  var otTb = document.querySelector('#tblOvertime tbody');
  otTb.innerHTML = '';
  document.getElementById('otCount').innerText = (res.overtime || []).length + '名';

  if(!res.overtime || res.overtime.length === 0){
    otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">本日の残業申請はありません</td></tr>';
  } else {
    res.overtime.forEach(function(it){ otTb.appendChild(buildOvertimeRow(it)); });
  }

  // 休日テーブル
  var hdTb = document.querySelector('#tblHoliday tbody');
  hdTb.innerHTML = '';
  document.getElementById('hdCount').innerText = (res.holiday || []).length + '名';

  if(!res.holiday || res.holiday.length === 0){
    hdTb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:24px">今週末の休日出勤申請はありません</td></tr>';
  } else {
    res.holiday.forEach(function(it){ hdTb.appendChild(buildHolidayRow(it)); });
  }
}

function buildOvertimeRow(it){
  var statusPill = it.status === 'submitted'
    ? '<span class="pill warn">未承認</span>'
    : '<span class="pill ok">承認済</span>';

  var submittedTime = fmtTime(it.submittedAt);
  var actionCell = buildActionCell(it);

  var tr = document.createElement('tr');
  tr.innerHTML =
    '<td>' + escHtml(it.dept) + '</td>' +
    '<td><b>' + escHtml(it.workerName) + '</b></td>' +
    '<td>' + statusPill + '</td>' +
    '<td>' + fmtMin(it.approvedMinutes) + '</td>' +
    '<td>' + submittedTime + '</td>' +
    '<td>' + actionCell + '</td>';
  return tr;
}

function buildHolidayRow(it){
  var statusPill = it.status === 'submitted'
    ? '<span class="pill warn">未承認</span>'
    : '<span class="pill ok">承認済</span>';

  var submittedTime = fmtTime(it.submittedAt);
  var actionCell = buildActionCell(it);

  var tr = document.createElement('tr');
  tr.innerHTML =
    '<td>' + escHtml(it.targetDateLabel || it.targetDate) + '</td>' +
    '<td>' + escHtml(it.dept) + '</td>' +
    '<td><b>' + escHtml(it.workerName) + '</b></td>' +
    '<td>' + statusPill + '</td>' +
    '<td>' + fmtMin(it.approvedMinutes) + '</td>' +
    '<td>' + submittedTime + '</td>' +
    '<td>' + actionCell + '</td>';
  return tr;
}

function fmtTime(val){
  if(!val) return '';
  try{
    var d = new Date(val);
    return z(d.getHours()) + ':' + z(d.getMinutes());
  } catch(e){ return ''; }
}

function buildActionCell(it){
  if(it.status === 'submitted'){
    return '<button class="btn-approve btn-sm" ' +
      'onclick="doApprove(\'' + it.requestId + '\',this)">承認</button>';
  }
  return '<span class="muted">承認済</span>';
}

// ====== 承認実行 ======
function doApprove(requestId, btn){
  if(!confirm('この申請を承認しますか？')) return;
  btn.disabled = true;
  btn.innerText = '処理中...';

  google.script.run
    .withSuccessHandler(function(){
      loadDashboard();
    })
    .withFailureHandler(function(err){
      alert('エラー: ' + (err.message || err));
      btn.disabled = false;
      btn.innerText = '承認';
    })
    .api_approveRequest(requestId);
}

// ====== 全件一括承認（残業 or 休日） ======
function approveAllInTable(type){
  var pending = ALL_ITEMS.filter(function(it){
    return it.status === 'submitted' && it.requestType === type;
  });
  if(pending.length === 0){
    alert('未承認の申請はありません。');
    return;
  }
  var label = type === 'overtime' ? '残業' : '休日出勤';
  if(!confirm(label + ' ' + pending.length + '件の申請を一括承認しますか？')) return;

  var done = 0;
  var errors = [];

  pending.forEach(function(it){
    google.script.run
      .withSuccessHandler(function(){
        done++;
        if(done === pending.length){
          if(errors.length > 0){
            alert('一括承認完了（エラー' + errors.length + '件）\n' + errors.join('\n'));
          }
          loadDashboard();
        }
      })
      .withFailureHandler(function(err){
        done++;
        errors.push(it.workerName + ': ' + (err.message || err));
        if(done === pending.length){
          alert('一括承認完了（エラー' + errors.length + '件）\n' + errors.join('\n'));
          loadDashboard();
        }
      })
      .api_approveRequest(it.requestId);
  });
}
</script>
</body>
</html>
