# 納品チェックリスト（〇×方式）

> 実装完了後に実施する受け入れ確認用。〇×で確認するだけで完了判定できる。

---

## 0. 事前情報・成果物確認

- [ ] DB スプレッドシート ID が確定している
- [ ] PDF テンプレスプレッドシート ID が確定している
- [ ] PDF 保存先フォルダ ID（`PDF_ROOT_FOLDER_ID`）が確定している
- [ ] 総務宛先（`HR_MAIL_TO`）が Settings に設定済み（カンマ区切り複数可）
- [ ] Web アプリ URL（`APP_URL`）が Settings に設定済み
- [ ] スコープ（Drive/Form/Gmail/UrlFetch）が有効で認可済み
- [ ] シート名・ヘッダ名がテンプレ通りで変更されていない

---

## 1. DB 構造（スプレッドシート）チェック

### 1-1. 必須シート存在

- [ ] Settings
- [ ] Requests
- [ ] WorkLogs
- [ ] DeptMaster（または Departments）
- [ ] WorkerMaster（または Workers）
- [ ] WorkNoMaster（工番）
- [ ] ApproverMap（部署 × 承認者 × role）
- [ ] （PDF 用）申請書テンプレシートが存在（残業/休日）

### 1-2. Requests 主要列（存在チェック）

- [ ] requestId
- [ ] status(submitted/approved/canceled)
- [ ] requestType(overtime/holiday)
- [ ] dept
- [ ] workerName
- [ ] targetDate
- [ ] approvedMinutes
- [ ] submittedAt
- [ ] approvedAt
- [ ] pdfFileId
- [ ] pdfGeneratedAt

### 1-3. WorkLogs 主要列（存在チェック）

- [ ] requestId
- [ ] actualStartAt（休日用）
- [ ] actualEndAt（残業・休日）
- [ ] actualMinutes
- [ ] breakMinutes
- [ ] netMinutes

---

## 2. 申請（Google フォーム連携）チェック

### 2-1. フォーム仕様

- [ ] 残業フォームが存在し、工番はプルダウン
- [ ] 休日フォームが存在し、工番はプルダウン
- [ ] 予定時間の値が仕様通り（残業 0.5 刻み、休日 = 半日/1 日）
- [ ] 理由の選択肢が仕様通り（その他は補足理由必須）

### 2-2. onFormSubmit の動作

- [ ] フォーム送信で Requests に 1 行追加される
- [ ] requestId（UUID）が必ず入る
- [ ] status が submitted で登録される
- [ ] approvedMinutes が「分」で正規化されている
- [ ] submittedAt がタイムスタンプで入る
- [ ] TOP に表示できる最小情報（部署・氏名・日付・種別・予定）が揃う

---

## 3. Web アプリ TOP 画面（作業者側）チェック

### 3-1. UI 要素

- [ ] 「残業」「休日出勤」ボタンがある（押すと即フォームへ遷移）
- [ ] 「承認者画面」ボタンがある
- [ ] 「総務部管理」ボタンがある
- [ ] 本日の残業者・休日出勤者が一覧で表示される
- [ ] 各行に「部署」「氏名」「予定時間」「未承認/承認済」ラベルが表示される

### 3-2. 実績ボタン

- [ ] 残業：完了ボタンのみ表示
- [ ] 休日：開始ボタン＋完了ボタン表示
- [ ] ボタン押下で WorkLogs にタイムスタンプが記録される

---

## 4. 承認者画面チェック（部署別アクセス制御）

### 4-1. アクセス制御

- [ ] ApproverMap にある承認者のみ承認画面へ入れる
- [ ] 承認者は「自部署」の一覧だけ見える（または自部署ボタンのみ）

### 4-2. 承認処理

- [ ] 承認ボタン押下で Requests.status が approved になる
- [ ] approvedAt が記録される
- [ ] TOP 画面の該当行ラベルが承認済みに切り替わる
- [ ] 却下/差し戻しが必要な場合は canceled 扱い（表示対象から除外）

---

## 5. 実績（WorkLogs）計算チェック

### 5-1. 残業

- [ ] 完了時刻が記録される
- [ ] 実績時間ロジックが仕様通り（17:20 以降の扱い）で netMinutes に反映される

### 5-2. 休日

- [ ] 開始時刻が記録される
- [ ] 完了時刻が記録される
- [ ] breakMinutes がマスタ定義から差し引かれている
- [ ] netMinutes が正しく算出される（負にならない）

---

## 6. PDF 自動生成チェック（申請書）

### 6-1. トリガー条件

- [ ] 実績確定（完了ボタン）を起点に PDF 生成が走る
- [ ] PDF 生成前に必要情報が揃っている（requestId/申請内容/承認/実績）

### 6-2. 転記・出力

- [ ] 追加された申請書シートの列・行構成に合わせて転記できている
- [ ] A4 PDF が生成される
- [ ] Drive に保存される
- [ ] 保存先：`PDF_ROOT_FOLDER_ID/YYYY.MM.DD` フォルダ（なければ自動作成）
- [ ] Requests.pdfFileId / pdfGeneratedAt が入る

---

## 7. 自動メールチェック（総務通知）

### 7-1. 夕方メール（2 回）

- [ ] 17 時台に送信される（承認時間＝予定時間で OK）
- [ ] 18 時台に送信される（同様）
- [ ] 本文に「部署」「氏名」「残業/休日」「承認時間」が明確に列挙される
- [ ] APP_URL（アプリ URL）が本文に含まれる

### 7-2. 朝メール（翌朝）

- [ ] 7 時台に送信される
- [ ] 実績一覧が CSV または Excel（両方なら尚可）で添付される
- [ ] 本文に「残業 PDF 何件」「休日 PDF 何件」「合計何件」報告が含まれる
- [ ] 添付の実績は WorkLogs.netMinutes（実績）である

### 7-3. トリガー

- [ ] `setupMailTriggers_()` を実行してトリガーが設定される
- [ ] トリガーが重複しない（または再作成手順がある）

---

## 8. 総務部管理画面（見える化 DX）チェック

### 8-1. アクセス制御

- [ ] admin ロールのみアクセス可能

### 8-2. 月次 40h 監視（実績）

- [ ] 月次個人別合算（残業＋休日）が正しく集計される（netMinutes）
- [ ] 40h/60h ラインを基準に表示される
- [ ] 注意対象（30h 超 or 予測 40h 超）が抽出される
- [ ] PDF 未作成件数が分かる（承認済み＋実績あり＋pdf なし）

### 8-3. グラフ

- [ ] 個人別棒グラフが表示される（実績＋薄い予測）
- [ ] 部署別配分（円）が表示される
- [ ] 年度推移（折れ線）が表示される（4/1〜3/31）

### 8-4. 特別条項（年 6 回）管理

- [ ] 年度内の「月 60h 超」回数が個人別に出る
- [ ] 5 回以上は警告、6 回は危険表示

### 8-5. 未承認滞留監視

- [ ] status=submitted の一覧が出る
- [ ] 48h 超が警告表示される
- [ ] 部署別の傾向が把握できる

### 8-6. PDF リンク開封

- [ ] 総務画面から PDF をワンクリックで開ける

---

## 9. パフォーマンス／安全性／運用チェック

- [ ] 主要処理は requestId で更新し、同一申請を重複生成しない
- [ ] 二重クリック対策（ロックやステータスチェック）がある
- [ ] Logger / エラーハンドリングが最低限入っている
- [ ] 権限エラー時の表示が分かりやすい
- [ ] 文字化け・日付ズレ（タイムゾーン）が発生しない

---

## 最終受け入れテスト（必ずこの順で実施）

1. [ ] 残業フォーム送信 → TOP 表示
2. [ ] 承認者が承認 → TOP ラベル変更
3. [ ] 残業完了ボタン → WorkLogs 更新 → netMinutes 算出
4. [ ] PDF 生成 → 日付フォルダに保存 → Requests に pdfFileId 記録
5. [ ] `sendEveningMail_` 手動実行 → 文面 OK
6. [ ] `sendMorningMail_` 手動実行 → 添付 OK ＋ PDF 件数 OK
7. [ ] 総務画面で月次集計 ＝ WorkLogs と一致
8. [ ] 年度 60h 回数と未承認滞留が表示される

---

## 納品物チェック（提出物）

- [ ] GAS ソース一式（コード・HTML）
- [ ] DB スプレッドシート（テンプレに従う）
- [ ] PDF テンプレートシート（列/行構成確定）
- [ ] 設定値一覧（Settings キー表）
- [ ] トリガー設定手順（`setupMailTriggers_` 実行手順）
- [ ] 運用手順（総務宛先変更方法、承認者追加方法）
