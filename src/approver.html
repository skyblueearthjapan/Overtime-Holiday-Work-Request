<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#eaf6ff;
      --bg2:#f7fffb;
      --accent:#1f9d55;
      --accent2:#0ea5e9;
      --text:#0b2545;
      --muted:#5c6b7a;
      --card:#ffffffcc;
      --line:#d7e7f5;
      --danger:#ff5a5f;
      --warn:#ffb020;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 600px at 18% 0%, var(--bg1), transparent),
        radial-gradient(1100px 600px at 92% 20%, var(--bg2), transparent),
        linear-gradient(180deg, #ffffff, #f3fbff);
    }
    header{
      padding:18px 22px;
      display:flex; align-items:flex-end; justify-content:space-between;
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(8px);
      position:sticky; top:0;
      background: rgba(255,255,255,.55);
      z-index: 10;
    }
    .title{ font-weight:900; letter-spacing:.06em; }
    .sub{ opacity:.8; font-size:12px; color:var(--muted); }
    .wrap{ padding:18px 22px; max-width:960px; margin:0 auto; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px;
      box-shadow: 0 10px 30px rgba(10,40,80,.06);
    }
    .kpi{ font-size:22px; font-weight:900; }
    .kpi2{ font-size:18px; font-weight:900; }
    .grid3{ display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; }

    .sectionTitle{
      font-weight:900;
      letter-spacing:.05em;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:left;
    }
    th{
      font-size:12px;
      color:var(--muted);
    }
    select, input{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      min-width:160px;
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      background:linear-gradient(135deg, var(--accent), #1bd67f);
      color:#fff; font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(31,157,85,.20);
    }
    .ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn-sm{ padding:6px 10px; font-size:12px; border-radius:8px; }
    .btn-approve{
      background:linear-gradient(135deg, var(--accent), #1bd67f);
      box-shadow:0 6px 16px rgba(31,157,85,.20);
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#fff;
      display:inline-block;
      color:var(--text);
    }
    .danger{ border-color:#ffb3b3; background:#fff0f0; color:#7a0b0b; }
    .warn{ border-color:#ffd29e; background:#fff6eb; color:#7a4a0b; }
    .ok{ border-color:#bfe9d0; background:#f0fff6; color:#0b5a2b; }
    .info{ border-color:#b3d4ff; background:#f0f7ff; color:#0b2a5a; }
    .muted{ color:var(--muted); }
    a{ color:var(--accent2); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .nav-link{
      font-size:13px; padding:6px 12px; border-radius:8px;
      border:1px solid var(--line); background:#fff; color:var(--text);
    }
    .nav-link:hover{ background:var(--bg1); text-decoration:none; }
    .loading{ text-align:center; padding:30px; color:var(--muted); }

    @media (max-width:640px){
      header{ flex-direction:column; align-items:flex-start; gap:8px; }
      .wrap{ padding:12px 10px; }
      .grid3{ grid-template-columns:1fr; }
      .row{ flex-direction:column; align-items:stretch; }
      select, input{ min-width:auto; width:100%; }
      table{ font-size:12px; }
      th, td{ padding:8px 4px; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">承認者画面</div>
      <div class="sub" id="approverSub">読込中...</div>
    </div>
    <div class="row">
      <a href="<?= APP_URL ?>?page=top" target="_top" class="nav-link">トップへ</a>
      <a href="<?= APP_URL ?>?page=admin" target="_top" class="nav-link">総務部画面</a>
    </div>
  </header>

  <div class="wrap">

    <!-- 部署選択・フィルタ -->
    <div class="card" style="margin-bottom:12px">
      <div class="row">
        <div>
          <div class="sub">部署</div>
          <select id="dept"></select>
        </div>
        <button onclick="loadRequests()">表示</button>
        <button class="ghost btn-sm" onclick="approveAllSubmitted()">全件一括承認</button>
        <div style="flex:1"></div>
        <div class="sub" id="summary">-</div>
      </div>
    </div>

    <!-- KPI -->
    <div class="grid3" style="margin-bottom:12px">
      <div class="card">
        <div class="sub">本日の申請件数</div>
        <div class="kpi" id="kpiTotal">-</div>
      </div>
      <div class="card">
        <div class="sub">未承認</div>
        <div class="kpi" id="kpiPending" style="color:var(--warn)">-</div>
      </div>
      <div class="card">
        <div class="sub">承認済</div>
        <div class="kpi" id="kpiApproved" style="color:var(--accent)">-</div>
      </div>
    </div>

    <!-- 申請テーブル -->
    <div class="card">
      <div class="sectionTitle">
        <div>本日の申請（<span id="todayDate">-</span>）</div>
        <button class="ghost btn-sm" onclick="loadRequests()">更新</button>
      </div>
      <table id="tblRequests">
        <thead>
          <tr>
            <th>氏名</th>
            <th>種別</th>
            <th>承認</th>
            <th>予定時間</th>
            <th>提出</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="loading">部署を選択してください</td></tr>
        </tbody>
      </table>
    </div>

  </div>

<script>
var CURRENT_ITEMS = [];

function fmtMin(min){
  min = Math.max(0, Math.round(Number(min||0)));
  var h = Math.floor(min/60), r = min % 60;
  if(h===0) return r+'分';
  if(r===0) return h+'時間';
  return h+'時間'+r+'分';
}

function z(n){ return String(n).padStart(2,'0'); }

// ====== 初期：承認対象部署を取得 ======
google.script.run
  .withSuccessHandler(function(res){
    var sel = document.getElementById('dept');
    sel.innerHTML = '';

    if(res.isAdmin){
      document.getElementById('approverSub').innerText =
        '管理者（全部署承認可）';
    } else {
      document.getElementById('approverSub').innerText =
        '担当部署: ' + res.depts.join(', ');
    }

    if(res.depts.length === 0){
      document.getElementById('approverSub').innerText =
        '承認権限がありません。ApproverMapを確認してください。';
      return;
    }

    res.depts.forEach(function(d){
      var opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      sel.appendChild(opt);
    });

    // 自動で最初の部署をロード
    loadRequests();
  })
  .withFailureHandler(function(err){
    alert(err.message || err);
  })
  .api_getApproverDepts();

// ====== 申請一覧取得 ======
function loadRequests(){
  var dept = document.getElementById('dept').value;
  if(!dept) return;

  document.querySelector('#tblRequests tbody').innerHTML =
    '<tr><td colspan="6" class="loading">読込中...</td></tr>';

  google.script.run
    .withSuccessHandler(function(res){
      CURRENT_ITEMS = res.items || [];
      document.getElementById('todayDate').innerText = res.today;

      var submitted = 0, approved = 0;
      CURRENT_ITEMS.forEach(function(it){
        if(it.status === 'submitted') submitted++;
        if(it.status === 'approved') approved++;
      });

      // KPI
      document.getElementById('kpiTotal').innerText = CURRENT_ITEMS.length;
      document.getElementById('kpiPending').innerText = submitted;
      document.getElementById('kpiApproved').innerText = approved;
      document.getElementById('summary').innerText =
        '計' + CURRENT_ITEMS.length + '件 / 未承認:' + submitted + ' / 承認済:' + approved;

      renderTable();
    })
    .withFailureHandler(function(err){
      alert(err.message || err);
    })
    .api_getTodayRequestsForDept(dept);
}

// ====== テーブル描画 ======
function renderTable(){
  var tb = document.querySelector('#tblRequests tbody');
  tb.innerHTML = '';

  if(CURRENT_ITEMS.length === 0){
    tb.innerHTML =
      '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">' +
      '本日の申請はありません</td></tr>';
    return;
  }

  CURRENT_ITEMS.forEach(function(it){
    var typePill = it.requestType === 'overtime'
      ? '<span class="pill info">残業</span>'
      : '<span class="pill ok">休日</span>';

    var statusPill = '';
    if(it.status === 'submitted'){
      statusPill = '<span class="pill warn">未承認</span>';
    } else if(it.status === 'approved'){
      statusPill = '<span class="pill ok">承認済</span>';
    }

    var actionCell = '';
    if(it.status === 'submitted'){
      actionCell = '<button class="btn-approve btn-sm" ' +
        'onclick="doApprove(\'' + it.requestId + '\',this)">承認</button>';
    } else {
      actionCell = '<span class="muted">承認済</span>';
    }

    var submittedTime = '';
    if(it.submittedAt){
      try{
        var d = new Date(it.submittedAt);
        submittedTime = z(d.getHours()) + ':' + z(d.getMinutes());
      } catch(e){}
    }

    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td><b>' + it.workerName + '</b></td>' +
      '<td>' + typePill + '</td>' +
      '<td>' + statusPill + '</td>' +
      '<td>' + fmtMin(it.approvedMinutes) + '</td>' +
      '<td>' + submittedTime + '</td>' +
      '<td>' + actionCell + '</td>';
    tb.appendChild(tr);
  });
}

// ====== 承認実行 ======
function doApprove(requestId, btn){
  if(!confirm('この申請を承認しますか？')) return;
  btn.disabled = true;
  btn.innerText = '処理中...';

  google.script.run
    .withSuccessHandler(function(res){
      // テーブルを再取得
      loadRequests();
    })
    .withFailureHandler(function(err){
      alert('エラー: ' + (err.message || err));
      btn.disabled = false;
      btn.innerText = '承認';
    })
    .api_approveRequest(requestId);
}

// ====== 全件一括承認 ======
function approveAllSubmitted(){
  var pending = CURRENT_ITEMS.filter(function(it){ return it.status === 'submitted'; });
  if(pending.length === 0){
    alert('未承認の申請はありません。');
    return;
  }
  if(!confirm(pending.length + '件の申請を一括承認しますか？')) return;

  var done = 0;
  var errors = [];

  pending.forEach(function(it){
    google.script.run
      .withSuccessHandler(function(){
        done++;
        if(done === pending.length){
          if(errors.length > 0){
            alert('一括承認完了（エラー' + errors.length + '件）\n' + errors.join('\n'));
          }
          loadRequests();
        }
      })
      .withFailureHandler(function(err){
        done++;
        errors.push(it.workerName + ': ' + (err.message || err));
        if(done === pending.length){
          alert('一括承認完了（エラー' + errors.length + '件）\n' + errors.join('\n'));
          loadRequests();
        }
      })
      .api_approveRequest(it.requestId);
  });
}
</script>
</body>
</html>
