<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#eaf6ff;
      --bg2:#f7fffb;
      --accent:#1f9d55;
      --accent2:#0ea5e9;
      --text:#0b2545;
      --muted:#5c6b7a;
      --card:#ffffffcc;
      --line:#d7e7f5;
      --danger:#ff5a5f;
      --warn:#ffb020;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 600px at 18% 0%, var(--bg1), transparent),
        radial-gradient(1100px 600px at 92% 20%, var(--bg2), transparent),
        linear-gradient(180deg, #ffffff, #f3fbff);
    }
    header{
      padding:18px 22px;
      display:flex; align-items:flex-end; justify-content:space-between;
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(8px);
      position:sticky; top:0;
      background: rgba(255,255,255,.55);
      z-index: 10;
    }
    .title{ font-weight:900; letter-spacing:.06em; }
    .sub{ opacity:.8; font-size:12px; color:var(--muted); }
    .wrap{ padding:18px 22px; max-width:1060px; margin:0 auto; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px;
      box-shadow: 0 10px 30px rgba(10,40,80,.06);
    }
    .kpi{ font-size:22px; font-weight:900; }
    .grid3{ display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; }
    .sectionTitle{
      font-weight:900;
      letter-spacing:.05em;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .section-count{
      font-size:13px; font-weight:700; color:var(--accent2);
      margin-left:8px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:left;
    }
    th{
      font-size:12px;
      color:var(--muted);
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      background:linear-gradient(135deg, var(--accent), #1bd67f);
      color:#fff; font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(31,157,85,.20);
    }
    .ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn-sm{ padding:6px 10px; font-size:12px; border-radius:8px; }
    .btn-approve{
      background:linear-gradient(135deg, var(--accent), #1bd67f);
      box-shadow:0 6px 16px rgba(31,157,85,.20);
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#fff;
      display:inline-block;
      color:var(--text);
    }
    .danger{ border-color:#ffb3b3; background:#fff0f0; color:#7a0b0b; }
    .warn{ border-color:#ffd29e; background:#fff6eb; color:#7a4a0b; }
    .ok{ border-color:#bfe9d0; background:#f0fff6; color:#0b5a2b; }
    .info{ border-color:#b3d4ff; background:#f0f7ff; color:#0b2a5a; }
    .muted{ color:var(--muted); }
    a{ color:var(--accent2); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .nav-link{
      font-size:13px; padding:6px 12px; border-radius:8px;
      border:1px solid var(--line); background:#fff; color:var(--text);
    }
    .nav-link:hover{ background:var(--bg1); text-decoration:none; }
    .loading{ text-align:center; padding:30px; color:var(--muted); }

    /* ---- 月次セクション（折りたたみ） ---- */
    .section-toggle{
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
    }
    .section-toggle .arrow{
      transition: transform .2s;
      font-size:14px; color:var(--muted);
    }
    .section-toggle .arrow.open{ transform: rotate(90deg); }
    .monthly-body{
      display:none;
      padding:0 14px 14px;
    }
    .monthly-body.open{ display:block; }
    .approver-chart{ width:100%; height:260px; }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      display:inline-flex; gap:6px; align-items:center;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip input{ transform: scale(1.1); }
    .monthly-filters{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin-bottom:10px;
    }
    .monthly-filters input[type="text"],
    .monthly-filters input[type="month"]{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
    }
    .mini-kpi-row{
      display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr;
      margin-bottom:10px;
    }
    .mini-kpi{
      background:#f8fbff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      text-align:center;
    }
    .mini-kpi .val{ font-size:20px; font-weight:900; }
    #tblApproverMonthly th,
    #tblApproverWatch th{
      cursor:pointer;
    }

    @media (max-width:640px){
      header{ flex-direction:column; align-items:flex-start; gap:8px; }
      .wrap{ padding:12px 10px; }
      .grid3{ grid-template-columns:1fr; }
      .row{ flex-direction:column; align-items:stretch; }
      table{ font-size:12px; }
      th, td{ padding:8px 4px; }
      .monthly-filters{ flex-direction:column; align-items:stretch; }
      .mini-kpi-row{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">承認者画面</div>
      <div class="sub" id="approverSub">読込中...</div>
    </div>
    <div class="row">
      <button class="ghost btn-sm" id="btnChangeDept" onclick="initApprover()" style="display:none;">部署変更</button>
      <a href="<?= APP_URL ?>?page=top" target="_top" class="nav-link">トップへ</a>
      <a href="<?= APP_URL ?>?page=admin" target="_top" class="nav-link">総務部画面</a>
    </div>
  </header>

  <div class="wrap">

    <!-- KPI -->
    <div class="grid3" style="margin-bottom:12px">
      <div class="card">
        <div class="sub">申請件数（残業+休日）</div>
        <div class="kpi" id="kpiTotal">-</div>
      </div>
      <div class="card">
        <div class="sub">未承認</div>
        <div class="kpi" id="kpiPending" style="color:var(--warn)">-</div>
      </div>
      <div class="card">
        <div class="sub">承認済</div>
        <div class="kpi" id="kpiApproved" style="color:var(--accent)">-</div>
      </div>
    </div>

    <!-- 残業セクション -->
    <div class="card" style="margin-bottom:12px;">
      <div class="sectionTitle">
        <div>
          本日の残業申請（<span id="todayDate">-</span>）
          <span class="section-count" id="otCount"></span>
        </div>
        <div class="row" style="gap:6px;">
          <button class="ghost btn-sm" onclick="approveAllInTable('overtime')">残業 全件承認</button>
          <button class="ghost btn-sm" onclick="loadDashboard()">更新</button>
        </div>
      </div>
      <table id="tblOvertime">
        <thead>
          <tr>
            <th>部署</th>
            <th>氏名</th>
            <th>承認</th>
            <th>予定時間</th>
            <th>提出</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="loading">読込中...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 休日セクション -->
    <div class="card">
      <div class="sectionTitle">
        <div>
          今週末の休日出勤申請（<span id="weekendRange">-</span>）
          <span class="section-count" id="hdCount"></span>
        </div>
        <button class="ghost btn-sm" onclick="approveAllInTable('holiday')">休日 全件承認</button>
      </div>
      <table id="tblHoliday">
        <thead>
          <tr>
            <th>日付</th>
            <th>部署</th>
            <th>氏名</th>
            <th>承認</th>
            <th>予定時間</th>
            <th>提出</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" class="loading">読込中...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 月次サマリー（折りたたみ） -->
    <div class="card" style="margin-top:12px;">
      <div class="section-toggle" onclick="toggleMonthly()">
        <div style="font-weight:900; letter-spacing:.05em;">
          月次：個人別サマリー
          <span class="sub" style="margin-left:8px;">実績・予測・40h/60h監視</span>
        </div>
        <span class="arrow" id="monthlyArrow">&#9654;</span>
      </div>

      <div class="monthly-body" id="monthlyBody">
        <!-- フィルタ行 -->
        <div class="monthly-filters">
          <input type="month" id="approverYm" />
          <input type="text" id="approverQ" placeholder="氏名検索" style="min-width:120px;" oninput="onApproverFilterChange()">
          <label class="chip"><input type="checkbox" id="afOver40" onchange="onApproverFilterChange()"> 40h超</label>
          <label class="chip"><input type="checkbox" id="afOver60" onchange="onApproverFilterChange()"> 60h超</label>
          <label class="chip"><input type="checkbox" id="afProj40" onchange="onApproverFilterChange()"> 予測40h超</label>
          <label class="chip"><input type="checkbox" id="afPdfMiss" onchange="onApproverFilterChange()"> PDF未作成</label>
          <button class="ghost btn-sm" onclick="loadApproverMonthly()">更新</button>
        </div>

        <!-- ミニKPI -->
        <div class="mini-kpi-row">
          <div class="mini-kpi">
            <div class="sub">対象人数</div>
            <div class="val" id="mkpiPeople">-</div>
          </div>
          <div class="mini-kpi">
            <div class="sub">40h超（実績/予測）</div>
            <div class="val" id="mkpi40">-</div>
          </div>
          <div class="mini-kpi">
            <div class="sub">PDF未作成</div>
            <div class="val" id="mkpiPdf" style="color:var(--warn);">-</div>
          </div>
        </div>

        <!-- バーチャート -->
        <div style="margin-bottom:10px;">
          <canvas id="cApproverPeople" class="approver-chart"></canvas>
          <div class="sub" id="approverChartInfo"></div>
        </div>

        <!-- 月次テーブル -->
        <div style="margin-bottom:10px;">
          <div class="sectionTitle">
            <div>個人別一覧</div>
            <div class="sub">列見出しクリックで並び替え</div>
          </div>
          <table id="tblApproverMonthly">
            <thead>
              <tr>
                <th data-k="workerName">氏名</th>
                <th data-k="totalNet">合算(分)</th>
                <th data-k="totalNetH">合算</th>
                <th data-k="overtimeNet">残業</th>
                <th data-k="holidayNet">休日</th>
                <th data-k="remain40">40残</th>
                <th data-k="projectedTotal">予測</th>
                <th data-k="pdfMissing">PDF</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- 注意対象テーブル -->
        <div>
          <div class="sectionTitle">
            <div>注意対象</div>
            <div class="sub">30h超 or 予測40h超</div>
          </div>
          <table id="tblApproverWatch">
            <thead>
              <tr>
                <th>氏名</th>
                <th>実績</th>
                <th>予測</th>
                <th>40残</th>
                <th>60残</th>
                <th>PDF</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<!-- 部署選択モーダル -->
<div id="deptModalWrap" style="display:none;">
  <div style="position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:100;"></div>
  <div class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:101; max-width:400px; width:90%; padding:24px; text-align:center;">
    <div style="font-weight:900; font-size:18px; margin-bottom:4px;">部署を選択</div>
    <div class="sub" style="margin-bottom:18px;">承認対象の部署を選んでください</div>
    <div id="deptModalBody">
      <div class="loading">承認者情報を確認中...</div>
    </div>
  </div>
</div>

<script>
var ALL_ITEMS = [];
var SELECTED_DEPT = '';

function fmtMin(min){
  min = Math.max(0, Math.round(Number(min||0)));
  var h = Math.floor(min/60), r = min % 60;
  if(h===0) return r+'分';
  if(r===0) return h+'時間';
  return h+'時間'+r+'分';
}

function z(n){ return String(n).padStart(2,'0'); }

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ====== 初期ロード ======
initApprover();

function initApprover(){
  SELECTED_DEPT = '';
  document.getElementById('btnChangeDept').style.display = 'none';
  document.getElementById('deptModalWrap').style.display = 'block';
  document.getElementById('deptModalBody').innerHTML = '<div class="loading">承認者情報を確認中...</div>';

  google.script.run
    .withSuccessHandler(function(res){
      var body = document.getElementById('deptModalBody');
      body.innerHTML = '';

      if(!res || !res.depts || res.depts.length === 0){
        body.innerHTML = '<div class="muted" style="padding:16px;">承認可能な部署がありません。</div>';
        return;
      }

      // 部署が1つだけ（非管理者）の場合はモーダルをスキップ
      if(!res.isAdmin && res.depts.length === 1){
        selectDept(res.depts[0]);
        return;
      }

      // 部署ボタンを動的生成
      res.depts.forEach(function(dept){
        var btn = document.createElement('button');
        btn.className = 'ghost';
        btn.style.cssText = 'width:100%; margin-bottom:8px; text-align:left; padding:12px 16px; font-size:14px;';
        btn.innerText = dept;
        btn.onclick = function(){ selectDept(dept); };
        body.appendChild(btn);
      });

      if(res.isAdmin){
        var note = document.createElement('div');
        note.className = 'sub';
        note.style.marginTop = '8px';
        note.innerText = '管理者: 全部署の承認が可能です';
        body.appendChild(note);
      }
    })
    .withFailureHandler(function(err){
      document.getElementById('deptModalBody').innerHTML =
        '<div class="muted" style="padding:16px;">エラー: ' + escHtml(err.message || err) + '</div>';
    })
    .api_getApproverDepts();
}

function selectDept(dept){
  SELECTED_DEPT = dept;
  // 月次セクションのステートをリセット（部署変更時）
  MONTHLY_STATE.data = null;
  MONTHLY_STATE.loaded = false;
  var body = document.getElementById('monthlyBody');
  if(body) body.classList.remove('open');
  var arrow = document.getElementById('monthlyArrow');
  if(arrow) arrow.classList.remove('open');
  closeDeptModal();
  loadDashboard(dept);
}

function closeDeptModal(){
  document.getElementById('deptModalWrap').style.display = 'none';
  document.getElementById('btnChangeDept').style.display = '';
}

function loadDashboard(dept){
  dept = dept || SELECTED_DEPT;
  if(!dept){
    initApprover();
    return;
  }
  SELECTED_DEPT = dept;

  var otTb = document.querySelector('#tblOvertime tbody');
  var hdTb = document.querySelector('#tblHoliday tbody');
  otTb.innerHTML = '<tr><td colspan="6" class="loading">読込中...</td></tr>';
  hdTb.innerHTML = '<tr><td colspan="7" class="loading">読込中...</td></tr>';

  google.script.run
    .withSuccessHandler(function(res){
      console.log('api_getApproverDashboard 結果:', JSON.stringify(res));
      if(!res){
        document.getElementById('approverSub').innerText = 'サーバーからnullが返されました';
        otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">データを取得できませんでした（res=null）。デプロイ済みか確認してください。</td></tr>';
        hdTb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:24px">デプロイの「新しいデプロイ」ではなく既存デプロイの更新が必要です</td></tr>';
        return;
      }

      // サーバー側でキャッチしたエラーを表示
      if(res.error){
        document.getElementById('approverSub').innerText = 'サーバーエラー';
        otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">サーバーエラー: ' + escHtml(res.error) + '</td></tr>';
        hdTb.innerHTML = '<tr><td colspan="7"></td></tr>';
        return;
      }

      document.getElementById('approverSub').innerText =
        (res.selectedDept || SELECTED_DEPT) + ' の申請' +
        (res.isAdmin ? '（管理者）' : '');

      ALL_ITEMS = (res.overtime || []).concat(res.holiday || []);
      renderDashboard(res);
    })
    .withFailureHandler(function(err){
      console.error('api_getApproverDashboard 失敗:', err);
      document.getElementById('approverSub').innerText = 'API呼出失敗';
      otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">API失敗: ' + escHtml(err.message || err) + '</td></tr>';
      hdTb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:24px">GASエディタのログ（実行数）も確認してください</td></tr>';
    })
    .api_getApproverDashboard(dept);
}

function renderDashboard(res){
  document.getElementById('todayDate').innerText = res.today;
  document.getElementById('weekendRange').innerText = res.weekendStart + ' ～ ' + res.weekendEnd;

  // KPI
  var allItems = (res.overtime || []).concat(res.holiday || []);
  var submitted = 0, approved = 0;
  allItems.forEach(function(it){
    if(it.status === 'submitted') submitted++;
    if(it.status === 'approved') approved++;
  });
  document.getElementById('kpiTotal').innerText = allItems.length;
  document.getElementById('kpiPending').innerText = submitted;
  document.getElementById('kpiApproved').innerText = approved;

  // 残業テーブル
  var otTb = document.querySelector('#tblOvertime tbody');
  otTb.innerHTML = '';
  document.getElementById('otCount').innerText = (res.overtime || []).length + '名';

  if(!res.overtime || res.overtime.length === 0){
    otTb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px">本日の残業申請はありません</td></tr>';
  } else {
    res.overtime.forEach(function(it){ otTb.appendChild(buildOvertimeRow(it)); });
  }

  // 休日テーブル
  var hdTb = document.querySelector('#tblHoliday tbody');
  hdTb.innerHTML = '';
  document.getElementById('hdCount').innerText = (res.holiday || []).length + '名';

  if(!res.holiday || res.holiday.length === 0){
    hdTb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:24px">今週末の休日出勤申請はありません</td></tr>';
  } else {
    res.holiday.forEach(function(it){ hdTb.appendChild(buildHolidayRow(it)); });
  }
}

function buildOvertimeRow(it){
  var statusPill = it.status === 'submitted'
    ? '<span class="pill warn">未承認</span>'
    : '<span class="pill ok">承認済</span>';

  var submittedTime = fmtTime(it.submittedAt);
  var actionCell = buildActionCell(it);

  var tr = document.createElement('tr');
  tr.setAttribute('data-request-id', it.requestId);
  tr.innerHTML =
    '<td>' + escHtml(it.dept) + '</td>' +
    '<td><b>' + escHtml(it.workerName) + '</b></td>' +
    '<td>' + statusPill + '</td>' +
    '<td>' + fmtMin(it.approvedMinutes) + '</td>' +
    '<td>' + submittedTime + '</td>' +
    '<td>' + actionCell + '</td>';
  return tr;
}

function buildHolidayRow(it){
  var statusPill = it.status === 'submitted'
    ? '<span class="pill warn">未承認</span>'
    : '<span class="pill ok">承認済</span>';

  var submittedTime = fmtTime(it.submittedAt);
  var actionCell = buildActionCell(it);

  var tr = document.createElement('tr');
  tr.setAttribute('data-request-id', it.requestId);
  tr.innerHTML =
    '<td>' + escHtml(it.targetDateLabel || it.targetDate) + '</td>' +
    '<td>' + escHtml(it.dept) + '</td>' +
    '<td><b>' + escHtml(it.workerName) + '</b></td>' +
    '<td>' + statusPill + '</td>' +
    '<td>' + fmtMin(it.approvedMinutes) + '</td>' +
    '<td>' + submittedTime + '</td>' +
    '<td>' + actionCell + '</td>';
  return tr;
}

function fmtTime(val){
  if(!val) return '';
  try{
    var d = new Date(val);
    return z(d.getHours()) + ':' + z(d.getMinutes());
  } catch(e){ return ''; }
}

function buildActionCell(it){
  if(it.status === 'submitted'){
    return '<button class="btn-approve btn-sm" ' +
      'onclick="doApprove(\'' + it.requestId + '\',this)">承認</button>';
  }
  return '<span class="muted">承認済</span>';
}

function updateRowToApproved(requestId) {
  var row = document.querySelector('tr[data-request-id="' + requestId + '"]');
  if (!row) return;
  var cells = row.querySelectorAll('td');
  var isHoliday = row.closest('table').id === 'tblHoliday';
  var statusIdx = isHoliday ? 3 : 2;
  var actionIdx = isHoliday ? 6 : 5;

  cells[statusIdx].innerHTML = '<span class="pill ok">承認済</span>';
  cells[actionIdx].innerHTML = '<span class="muted">承認済</span>';

  // 視覚フィードバック（緑フラッシュ）
  row.style.transition = 'background 0.4s';
  row.style.background = 'rgba(31,157,85,0.08)';
  setTimeout(function(){ row.style.background = ''; }, 1200);

  // ALL_ITEMS の状態も更新
  for (var i = 0; i < ALL_ITEMS.length; i++) {
    if (ALL_ITEMS[i].requestId === requestId) {
      ALL_ITEMS[i].status = 'approved';
      break;
    }
  }
  updateKpiCounters();
}

function updateKpiCounters() {
  var submitted = 0, approved = 0;
  ALL_ITEMS.forEach(function(it) {
    if (it.status === 'submitted') submitted++;
    if (it.status === 'approved') approved++;
  });
  document.getElementById('kpiTotal').innerText = ALL_ITEMS.length;
  document.getElementById('kpiPending').innerText = submitted;
  document.getElementById('kpiApproved').innerText = approved;
}

// ====== 承認実行 ======
function doApprove(requestId, btn){
  if(!confirm('この申請を承認しますか？')) return;
  btn.disabled = true;
  updateRowToApproved(requestId);  // 即時反映

  google.script.run
    .withSuccessHandler(function(){})  // 成功時: 何もしない（既に反映済み）
    .withFailureHandler(function(err){
      alert('エラー: ' + (err.message || err));
      loadDashboard();  // 失敗時のみ全件リロードで復元
    })
    .api_approveRequest(requestId);
}

// ====== 全件一括承認（残業 or 休日） ======
function approveAllInTable(type){
  var pending = ALL_ITEMS.filter(function(it){
    return it.status === 'submitted' && it.requestType === type;
  });
  if(pending.length === 0){ alert('未承認の申請はありません。'); return; }
  var label = type === 'overtime' ? '残業' : '休日出勤';
  if(!confirm(label + ' ' + pending.length + '件を一括承認しますか？')) return;

  // 即時: 全行を承認済みに更新
  var requestIds = [];
  pending.forEach(function(it){
    requestIds.push(it.requestId);
    updateRowToApproved(it.requestId);
  });

  // 1回のAPI呼出しで一括承認
  google.script.run
    .withSuccessHandler(function(res){
      var errors = [];
      if(res && res.results){
        res.results.forEach(function(r){
          if(!r.ok) errors.push(r.requestId + ': ' + (r.error || '不明'));
        });
      }
      if(errors.length > 0){
        alert('一括承認完了（エラー' + errors.length + '件）\n' + errors.join('\n'));
        loadDashboard();
      }
    })
    .withFailureHandler(function(err){
      alert('一括承認エラー: ' + (err.message || err));
      loadDashboard();
    })
    .api_approveRequestsBatch(requestIds);
}

// ====== 月次サマリー ======
var MONTHLY_STATE = {
  data: null,
  loaded: false,
  sortKey: 'totalNet',
  sortDir: 'desc',
  visiblePeople: []
};

// 月選択の初期値
(function(){
  var d = new Date();
  var ym = d.getFullYear() + '-' + z(d.getMonth()+1);
  var el = document.getElementById('approverYm');
  if(el) el.value = ym;
})();

function toggleMonthly(){
  var body = document.getElementById('monthlyBody');
  var arrow = document.getElementById('monthlyArrow');
  var isOpen = body.classList.contains('open');

  if(isOpen){
    body.classList.remove('open');
    arrow.classList.remove('open');
  } else {
    body.classList.add('open');
    arrow.classList.add('open');
    // 初回展開時に自動ロード
    if(!MONTHLY_STATE.loaded && SELECTED_DEPT){
      loadApproverMonthly();
    }
  }
}

function loadApproverMonthly(){
  if(!SELECTED_DEPT) return;
  var ym = document.getElementById('approverYm').value;
  if(!ym) return;

  // ローディング表示
  var tb = document.querySelector('#tblApproverMonthly tbody');
  tb.innerHTML = '<tr><td colspan="8" class="loading">読込中...</td></tr>';
  var wb = document.querySelector('#tblApproverWatch tbody');
  wb.innerHTML = '<tr><td colspan="6" class="loading">読込中...</td></tr>';

  google.script.run
    .withSuccessHandler(function(res){
      MONTHLY_STATE.data = res;
      MONTHLY_STATE.loaded = true;
      renderApproverMonthly();
    })
    .withFailureHandler(function(err){
      alert('月次サマリー取得エラー: ' + (err.message || err));
      tb.innerHTML = '<tr><td colspan="8" class="muted" style="text-align:center;padding:24px;">エラー: ' + escHtml(err.message || err) + '</td></tr>';
      wb.innerHTML = '';
    })
    .api_approverMonthlySummary(ym, SELECTED_DEPT);
}

function applyApproverFilters(people){
  var q = (document.getElementById('approverQ').value || '').trim();
  var fOver40 = document.getElementById('afOver40').checked;
  var fOver60 = document.getElementById('afOver60').checked;
  var fProj40 = document.getElementById('afProj40').checked;
  var fPdfMiss = document.getElementById('afPdfMiss').checked;

  var out = people.slice();
  if(q) out = out.filter(function(p){ return (p.workerName||'').indexOf(q) >= 0; });
  if(fOver40) out = out.filter(function(p){ return p.totalNet >= 2400; });
  if(fOver60) out = out.filter(function(p){ return p.totalNet >= 3600; });
  if(fProj40) out = out.filter(function(p){ return p.projectedTotal >= 2400; });
  if(fPdfMiss) out = out.filter(function(p){ return (p.pdfMissing||0) > 0; });

  // sort
  var k = MONTHLY_STATE.sortKey;
  var dir = MONTHLY_STATE.sortDir;
  out.sort(function(a,b){
    var av = (k==='totalNetH') ? a.totalNet : (a[k] != null ? a[k] : '');
    var bv = (k==='totalNetH') ? b.totalNet : (b[k] != null ? b[k] : '');
    if(typeof av === 'number' && typeof bv === 'number'){
      return dir==='asc' ? av-bv : bv-av;
    }
    return dir==='asc'
      ? String(av).localeCompare(String(bv),'ja')
      : String(bv).localeCompare(String(av),'ja');
  });

  return out;
}

function onApproverFilterChange(){
  if(MONTHLY_STATE.data) renderApproverMonthly();
}

function renderApproverMonthly(){
  var res = MONTHLY_STATE.data;
  if(!res) return;

  // ミニKPI
  document.getElementById('mkpiPeople').innerText = res.kpi.totalPeople;
  document.getElementById('mkpi40').innerText = res.kpi.over40 + ' / ' + res.kpi.projectedOver40;
  document.getElementById('mkpiPdf').innerText = res.kpi.pdfMissingTotal;

  // フィルタ＆ソート
  var visible = applyApproverFilters(res.people);
  MONTHLY_STATE.visiblePeople = visible;

  // テーブル描画
  var tb = document.querySelector('#tblApproverMonthly tbody');
  tb.innerHTML = '';
  if(visible.length === 0){
    tb.innerHTML = '<tr><td colspan="8" class="muted" style="text-align:center;padding:24px;">該当データなし</td></tr>';
  } else {
    visible.forEach(function(p){
      var remain40 = Math.max(0, 2400 - p.totalNet);
      var badge40 = remain40===0 ? '<span class="pill danger">超過</span>' :
        (remain40<=300 ? '<span class="pill warn">'+fmtMin(remain40)+'残</span>' : '<span class="pill">'+fmtMin(remain40)+'残</span>');
      var proj = p.projectedTotal >= 3600 ? '<span class="pill danger">60超予測</span>' :
                   p.projectedTotal >= 2400 ? '<span class="pill warn">40超予測</span>' :
                   '<span class="pill ok">範囲内</span>';
      var pdf = (p.pdfMissing||0) > 0 ? '<span class="pill warn">'+p.pdfMissing+'件</span>' : '<span class="pill ok">0</span>';

      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td><b>'+escHtml(p.workerName)+'</b></td>'+
        '<td>'+p.totalNet+'</td>'+
        '<td><b>'+fmtMin(p.totalNet)+'</b></td>'+
        '<td>'+fmtMin(p.overtimeNet)+'</td>'+
        '<td>'+fmtMin(p.holidayNet)+'</td>'+
        '<td>'+badge40+'</td>'+
        '<td>'+fmtMin(p.projectedTotal)+' '+proj+'</td>'+
        '<td>'+pdf+'</td>';
      tb.appendChild(tr);
    });
  }

  // 注意対象テーブル
  var wb = document.querySelector('#tblApproverWatch tbody');
  wb.innerHTML = '';
  var watchList = (res.watch || []);
  if(watchList.length === 0){
    wb.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:24px;">注意対象なし</td></tr>';
  } else {
    watchList.forEach(function(w){
      var pdf = (w.pdfMissing||0) > 0 ? '<span class="pill warn">'+w.pdfMissing+'件</span>' : '<span class="pill ok">0</span>';
      var projBadge = w.projectedOver60 ? '<span class="pill danger">60超</span>' :
                      (w.projectedOver40 ? '<span class="pill warn">40超</span>' : '<span class="pill ok">範囲内</span>');
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td><b>'+escHtml(w.workerName)+'</b></td>'+
        '<td><b>'+fmtMin(w.totalNet)+'</b></td>'+
        '<td>'+fmtMin(w.projectedTotal)+' '+projBadge+'</td>'+
        '<td>'+fmtMin(w.remain40)+'</td>'+
        '<td>'+fmtMin(w.remain60)+'</td>'+
        '<td>'+pdf+'</td>';
      wb.appendChild(tr);
    });
  }

  // チャート描画
  drawApproverPeopleBar('cApproverPeople', visible, res.charts.people.limit40, res.charts.people.limit60);
  document.getElementById('approverChartInfo').innerText =
    '棒：表示中 '+visible.length+'名（実績=濃、予測=薄）。40h/60hラインは固定。';
}

// ====== Canvas描画 ======
function clearApproverCanvas(id){
  var c = document.getElementById(id);
  if(!c) return null;
  var ctx = c.getContext('2d');
  var rect = c.getBoundingClientRect();
  c.width = Math.floor(rect.width * devicePixelRatio);
  c.height = Math.floor(rect.height * devicePixelRatio);
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,rect.width,rect.height);
  return {c:c,ctx:ctx,w:rect.width,h:rect.height};
}

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function drawApproverPeopleBar(canvasId, people, limit40, limit60){
  var o = clearApproverCanvas(canvasId);
  if(!o) return;
  var ctx=o.ctx, w=o.w, h=o.h;
  var padL=44, padR=14, padT=14, padB=46;
  var innerW = w - padL - padR;
  var innerH = h - padT - padB;

  var maxVal = Math.max(limit60, 4000);
  for(var i=0;i<people.length;i++){
    if(people[i].totalNet > maxVal) maxVal = people[i].totalNet;
    if((people[i].projectedTotal||0) > maxVal) maxVal = people[i].projectedTotal;
  }
  var n = Math.max(1, people.length);
  var gap = 6;
  var barW = clamp((innerW - gap*(n-1)) / n, 6, 20);

  // grid lines
  ctx.font = '12px system-ui';
  ctx.fillStyle = '#5c6b7a';
  ctx.strokeStyle = '#d7e7f5';

  var ticks = [0, limit40, limit60, maxVal];
  ticks.forEach(function(t){
    var y = padT + innerH - (t/maxVal)*innerH;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+innerW,y); ctx.stroke();
    ctx.fillText(Math.round(t/60)+'h', 8, y+4);
  });

  // limit lines
  function drawLimitLine(yVal, label){
    ctx.save();
    var y = padT + innerH - (yVal/maxVal)*innerH;
    ctx.strokeStyle = '#1f9d55';
    ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+innerW,y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#1f9d55';
    ctx.fillText(label, padL+6, y-6);
    ctx.restore();
  }
  drawLimitLine(limit40, '40h');
  drawLimitLine(limit60, '60h');

  // bars
  people.forEach(function(p,i){
    var x = padL + i*(barW+gap);
    var v = p.totalNet;
    var pv = p.projectedTotal || 0;

    // projected (light)
    var ph = (pv/maxVal)*innerH;
    ctx.fillStyle = 'rgba(14,165,233,0.18)';
    ctx.fillRect(x, padT + innerH - ph, barW, ph);

    // actual (solid)
    var ah = (v/maxVal)*innerH;
    var over60 = v>=3600;
    var over40 = v>=2400;
    ctx.fillStyle = over60 ? 'rgba(255,90,95,0.68)' : (over40 ? 'rgba(255,176,32,0.68)' : 'rgba(31,157,85,0.62)');
    ctx.fillRect(x, padT + innerH - ah, barW, ah);

    // x label
    if(n<=40){
      var name = (p.workerName||'').slice(0,6);
      ctx.save();
      ctx.translate(x+barW/2, padT+innerH+22);
      ctx.rotate(-0.7);
      ctx.fillStyle='#5c6b7a';
      ctx.fillText(name, -10, 0);
      ctx.restore();
    }
  });

  // axis frame
  ctx.strokeStyle = '#d7e7f5';
  ctx.strokeRect(padL, padT, innerW, innerH);
}

// ====== テーブルソート ======
document.querySelectorAll('#tblApproverMonthly thead th').forEach(function(th){
  th.addEventListener('click', function(){
    var k = th.dataset.k;
    if(!k) return;
    if(MONTHLY_STATE.sortKey === k){
      MONTHLY_STATE.sortDir = (MONTHLY_STATE.sortDir === 'asc') ? 'desc' : 'asc';
    } else {
      MONTHLY_STATE.sortKey = k;
      MONTHLY_STATE.sortDir = 'desc';
    }
    renderApproverMonthly();
  });
});
</script>
</body>
</html>
